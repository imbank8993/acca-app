'use client';

import { useState, useEffect, useRef } from 'react';
import StudentSelect from './StudentSelect';
import Swal from 'sweetalert2';

interface AddModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSuccess: () => void;
    canDo: (res: string, act: string) => boolean;
    allowedTypes?: {
        IZIN: boolean;
        SAKIT: boolean;
    };
}

export default function AddModal({ isOpen, onClose, onSuccess, canDo, allowedTypes }: AddModalProps) {
    const [jenis, setJenis] = useState<'IZIN' | 'SAKIT'>('IZIN');
    const [status, setStatus] = useState('MADRASAH');
    const [isInitialized, setIsInitialized] = useState(false);
    const fileInputRef = useRef<HTMLInputElement>(null);

    // ... rest of state
    const [ketIzin, setKetIzin] = useState('');
    const [ketSakit, setKetSakit] = useState('');
    const [tglMulai, setTglMulai] = useState('');
    const [tglSelesai, setTglSelesai] = useState('');
    const [selectedNisns, setSelectedNisns] = useState<string[]>([]);
    const [uploading, setUploading] = useState(false);
    const [uploadProgress, setUploadProgress] = useState(0);
    const [uploadedFileUrl, setUploadedFileUrl] = useState('');
    const [uploadedFileName, setUploadedFileName] = useState('');

    useEffect(() => {
        if (isOpen && !isInitialized) {
            // Priority: allowedTypes prop > canDo check
            let allowedIzin = false;
            let allowedSakit = false;

            if (allowedTypes) {
                allowedIzin = allowedTypes.IZIN;
                allowedSakit = allowedTypes.SAKIT;
            } else {
                allowedIzin = canDo('ketidakhadiran.izin', 'manage');
                allowedSakit = canDo('ketidakhadiran.sakit', 'manage');
            }

            if (allowedIzin) {
                setJenis('IZIN');
                setStatus('MADRASAH');
            } else if (allowedSakit) {
                setJenis('SAKIT');
                setStatus('Ringan');
            }
            setIsInitialized(true);
        }

        if (!isOpen) {
            setIsInitialized(false);
        }
    }, [isOpen, allowedTypes, isInitialized]);

    const [submitting, setSubmitting] = useState(false);

    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!e.target.files || e.target.files.length === 0) return;

        const file = e.target.files[0];
        setUploading(true);
        setUploadProgress(0);
        setUploadedFileName(file.name);

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('folder', `Ketidakhadiran/${jenis.charAt(0) + jenis.slice(1).toLowerCase()}`);

            await new Promise<void>((resolve, reject) => {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (event) => {
                    if (event.lengthComputable) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        setUploadProgress(percent);
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (data.ok) {
                                setUploadedFileUrl(data.publicUrl);
                                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Upload berhasil!', timer: 1500, showConfirmButton: false });
                                resolve();
                            } else {
                                reject(new Error(data.error || 'Upload gagal'));
                            }
                        } catch (err) {
                            reject(new Error('Invalid response'));
                        }
                    } else {
                        reject(new Error('Upload failed'));
                    }
                });

                xhr.addEventListener('error', () => reject(new Error('Network error')));
                xhr.open('POST', 'https://icgowa.sch.id/acca.icgowa.sch.id/acca_upload.php');
                xhr.send(formData);
            });
        } catch (error: any) {
            console.error(error);
            Swal.fire('Upload Gagal', error.message || 'Gagal menghubungi server', 'error');
            setUploadedFileUrl('');
            setUploadedFileName('');
        } finally {
            setUploading(false);
            setUploadProgress(0);
        }
    };

    // Reset form when opening must be handled by effect or parent, assume simple unmount for now
    if (!isOpen) return null;

    const handleSubmit = async () => {
        // Validation
        if (!tglMulai) {
            Swal.fire({ title: 'Validasi', text: 'Tanggal mulai wajib diisi', icon: 'warning', confirmButtonColor: '#0b1b3a' });
            return;
        }

        // Jika tglSelesai kosong, gunakan tglMulai (absen 1 hari)
        const finalTglSelesai = tglSelesai || tglMulai;
        if (selectedNisns.length === 0) {
            Swal.fire({ title: 'Validasi', text: 'Pilih minimal 1 siswa', icon: 'warning', confirmButtonColor: '#0b1b3a' });
            return;
        }

        let keterangan = '';
        if (jenis === 'IZIN') {
            if (!ketIzin) {
                Swal.fire({ title: 'Validasi', text: 'Keterangan izin wajib diisi', icon: 'warning' });
                return;
            }
            keterangan = ketIzin;
        } else {
            if (!ketSakit) {
                Swal.fire({ title: 'Validasi', text: 'Keterangan sakit wajib diisi', icon: 'warning', confirmButtonColor: '#0b1b3a' });
                return;
            }
            keterangan = ketSakit;
        }

        setSubmitting(true);

        try {
            const payload = {
                jenis,
                status,
                tgl_mulai: tglMulai,
                tgl_selesai: finalTglSelesai,
                keterangan,
                nisList: selectedNisns,
                file_url: uploadedFileUrl || null
            };

            // Get Supabase session token for auth
            const { supabase } = await import('@/lib/supabase');
            const { data: { session } } = await supabase.auth.getSession();

            const headers: HeadersInit = { 'Content-Type': 'application/json' };
            if (session?.access_token) {
                headers['Authorization'] = `Bearer ${session.access_token}`;
            }

            const res = await fetch('/api/ketidakhadiran/bulk', {
                method: 'POST',
                headers,
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            setSubmitting(false);

            if (data.ok) {
                let message = `Berhasil menambahkan ${data.added} data`;
                if (data.warnings && data.warnings.length > 0) {
                    message += `<br><br><small>⚠️ ${data.warnings.length} warning overlap</small>`;
                }

                await Swal.fire({
                    title: 'Berhasil',
                    html: message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

                onSuccess();
                onClose();
            } else {
                Swal.fire({
                    title: 'Gagal',
                    text: data.error || 'Terjadi kesalahan saat menyimpan',
                    icon: 'error',
                    confirmButtonColor: '#0b1b3a'
                });
            }

        } catch (error: any) {
            console.error(error);
            Swal.fire({
                title: 'Error',
                text: error.message || 'Terjadi kesalahan sistem (Network)',
                icon: 'error',
                confirmButtonColor: '#0b1b3a'
            });
        } finally {
            setSubmitting(false);
        }
    };

    return (
        <div className="modal-backdrop">
            <div className="modal-container">

                {/* Header */}
                <div className="modal-header">
                    <div>
                        <h3>Tambah Data Absen</h3>
                        <p>Input data izin atau sakit siswa</p>
                    </div>
                    <button onClick={onClose} className="close-btn">
                        <i className="bi bi-x-lg"></i>
                    </button>
                </div>

                {/* Body */}
                <div className="modal-body">
                    {/* Row 1: Jenis & Status */}
                    <div className="grid-2">
                        <div className="form-group">
                            <label>Jenis Absen</label>
                            <div className="select-wrapper">
                                <select
                                    value={jenis}
                                    onChange={(e) => {
                                        const newJenis = e.target.value as 'IZIN' | 'SAKIT';
                                        setJenis(newJenis);
                                        if (newJenis === 'IZIN') setStatus('MADRASAH');
                                        else setStatus('Ringan');
                                    }}
                                    className="form-input"
                                >
                                    {(allowedTypes?.IZIN || canDo('ketidakhadiran.izin', 'manage')) && <option value="IZIN">IZIN</option>}
                                    {(allowedTypes?.SAKIT || canDo('ketidakhadiran.sakit', 'manage')) && <option value="SAKIT">SAKIT</option>}
                                </select>
                                <i className="bi bi-chevron-down select-icon"></i>
                            </div>
                        </div>

                        <div className="form-group">
                            <label>Status</label>
                            <div className="select-wrapper">
                                <select
                                    value={status}
                                    onChange={(e) => setStatus(e.target.value)}
                                    className="form-input"
                                >
                                    {jenis === 'IZIN' ? (
                                        <>
                                            <option value="MADRASAH">MADRASAH</option>
                                            <option value="PERSONAL">PERSONAL</option>
                                        </>
                                    ) : (
                                        <>
                                            <option value="Ringan">Ringan</option>
                                            <option value="Sedang">Sedang</option>
                                            <option value="Berat">Berat</option>
                                            <option value="Kontrol">Kontrol</option>
                                        </>
                                    )}
                                </select>
                                <i className="bi bi-chevron-down select-icon"></i>
                            </div>
                        </div>
                    </div>

                    {/* Row 2: Date Range */}
                    <div className="grid-2">
                        <div className="form-group">
                            <label>Tanggal Mulai</label>
                            <input
                                type="date"
                                className="form-input"
                                value={tglMulai}
                                onChange={(e) => setTglMulai(e.target.value)}
                            />
                        </div>
                        <div className="form-group">
                            <label>Tanggal Selesai</label>
                            <input
                                type="date"
                                className="form-input"
                                value={tglSelesai}
                                onChange={(e) => setTglSelesai(e.target.value)}
                            />
                        </div>
                    </div>

                    {/* Conditional Keterangan */}
                    {jenis === 'IZIN' ? (
                        <div className="form-group mb-5">
                            <label>Keterangan Izin</label>
                            <p className="text-xs text-slate-500 mb-2">Gunakan tanda <b>|</b> untuk memisahkan informasi (Misal: Lomba | Penyelenggara | Lokasi)</p>
                            <textarea
                                className="form-input textarea"
                                rows={3}
                                placeholder="Contoh: Olimpiade Matematika | Dinas Pendidikan | Makassar"
                                value={ketIzin}
                                onChange={(e) => setKetIzin(e.target.value)}
                            />
                        </div>
                    ) : (
                        <div className="form-group mb-5">
                            <label>Keterangan / Diagnosa</label>
                            <textarea
                                className="form-input textarea"
                                rows={3}
                                placeholder="Jelaskan kondisi kesehatan siswa..."
                                value={ketSakit}
                                onChange={(e) => setKetSakit(e.target.value)}
                            />
                        </div>
                    )}

                    {/* Student Selector */}
                    <div className="form-group">
                        <label>Pilih Siswa</label>
                        <StudentSelect
                            selectedNisns={selectedNisns}
                            onSelectionChange={setSelectedNisns}
                        />
                    </div>

                    {/* File Upload */}
                    <div className="form-group">
                        <label>Upload Dokumen Pendukung (Opsional)</label>
                        <div className="upload-container">
                            <input
                                type="file"
                                id="file-upload"
                                className="hidden"
                                ref={fileInputRef}
                                onChange={handleFileUpload}
                                accept="image/*,application/pdf"
                                disabled={uploading}
                            />
                            <label htmlFor="file-upload" className={`upload-box ${uploading ? 'uploading' : ''}`}>
                                {uploading ? (
                                    <div className="spinner-sm"></div>
                                ) : uploadedFileUrl ? (
                                    <div className="uploaded-info">
                                        <i className="bi bi-file-earmark-check-fill"></i>
                                        <span>File siap disimpan</span>
                                    </div>
                                ) : (
                                    <div className="upload-placeholder">
                                        <i className="bi bi-cloud-arrow-up"></i>
                                        <span>Klik untuk pilih PDF atau Gambar</span>
                                    </div>
                                )}
                            </label>
                            {uploadedFileUrl && (
                                <button className="remove-file" onClick={() => {
                                    setUploadedFileUrl('');
                                    if (fileInputRef.current) fileInputRef.current.value = '';
                                }}>
                                    <i className="bi bi-trash"></i> Hapus
                                </button>
                            )}
                        </div>
                    </div>

                </div>

                {/* Footer */}
                <div className="modal-footer">
                    <button onClick={onClose} className="btn-cancel" disabled={submitting}>
                        Batal
                    </button>
                    <button onClick={handleSubmit} className="btn-save" disabled={submitting}>
                        {submitting ? (
                            <span className="flex items-center gap-2">
                                <span className="spinner"></span> Menyimpan...
                            </span>
                        ) : (
                            'Simpan Data'
                        )}
                    </button>
                </div>
            </div>

            <style jsx>{`
        .modal-backdrop {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(15, 23, 42, 0.6);
          backdrop-filter: blur(4px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }

        .modal-container {
          background: white;
          width: 95%;
          max-width: 650px;
          border-radius: 16px;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          display: flex;
          flex-direction: column;
          max-height: 90vh;
          animation: modalSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlide {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
          padding: 20px 24px;
          border-bottom: 1px solid #f1f5f9;
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          background: #f8fafc;
          border-top-left-radius: 16px;
          border-top-right-radius: 16px;
        }

        .modal-header h3 {
          margin: 0;
          font-size: 1.25rem;
          color: #0f172a;
          font-weight: 700;
        }

        .modal-header p {
          margin: 4px 0 0;
          font-size: 0.875rem;
          color: #64748b;
        }

        .close-btn {
          background: white;
          border: 1px solid #e2e8f0;
          width: 32px;
          height: 32px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: #64748b;
          transition: all 0.2s;
        }

        .close-btn:hover {
          background: #f1f5f9;
          color: #0f172a;
        }

        .modal-body {
          padding: 24px;
          overflow-y: auto;
          color: #334155;
        }

        .grid-2 {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 24px;
          margin-bottom: 24px;
        }

        @media (max-width: 640px) {
          .grid-2 {
            grid-template-columns: 1fr;
            gap: 20px;
          }
        }

        .form-group {
          margin-bottom: 24px;
        }

        .form-group label {
          display: block;
          font-size: 0.875rem;
          font-weight: 600;
          color: #334155; /* High contrast label */
          margin-bottom: 10px;
        }

        .select-wrapper {
          position: relative;
        }

        .form-input {
          width: 100%;
          padding: 14px 16px;
          border: 1px solid #cbd5e1;
          border-radius: 10px;
          font-size: 0.95rem;
          color: #0f172a; /* High contrast input text */
          background: white;
          transition: all 0.2s;
          appearance: none;
        }

        .form-input:focus {
          outline: none;
          border-color: #3aa6ff;
          box-shadow: 0 0 0 4px rgba(58, 166, 255, 0.1);
        }

        .form-input::placeholder {
          color: #94a3b8;
        }

        .textarea {
          resize: vertical;
          min-height: 100px;
          line-height: 1.5;
        }

        .select-icon {
          position: absolute;
          right: 16px;
          top: 50%;
          transform: translateY(-50%);
          color: #64748b;
          pointer-events: none;
          font-size: 0.9rem;
        }

        .bg-slate-50 { background-color: #f8fafc; }
        .p-4 { padding: 1rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .border-slate-200 { border-color: #e2e8f0; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-5 { margin-bottom: 2rem; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .text-slate-700 { color: #334155; }
        .uppercase { text-transform: uppercase; }
        .tracking-wider { letter-spacing: 0.05em; }

        .modal-footer {
          padding: 20px 24px;
          border-top: 1px solid #f1f5f9;
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          background: #f8fafc;
          border-bottom-left-radius: 16px;
          border-bottom-right-radius: 16px;
        }

        .btn-cancel {
          padding: 14px 20px;
          background: white;
          border: 1px solid #cbd5e1;
          color: #475569;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-cancel:hover {
          background: #f1f5f9;
          border-color: #94a3b8;
        }

        .btn-save {
          padding: 14px 24px;
          background: #0b1b3a; /* Navy Theme */
          border: none;
          color: white;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 6px -1px rgba(11, 27, 58, 0.15);
          transition: all 0.2s;
        }

        .btn-save:hover {
          background: #1e3a8a;
          transform: translateY(-1px);
          box-shadow: 0 6px 10px -2px rgba(11, 27, 58, 0.2);
        }

        .btn-save:disabled {
          opacity: 0.7;
          transform: none;
          cursor: not-allowed;
        }

        .loading-bars-inline {
          display: flex;
          gap: 3px;
          align-items: center;
          justify-content: center;
        }

        .loading-bars-inline .bar {
          width: 3px;
          height: 12px;
          background: #fff;
          border-radius: 99px;
          animation: waveInline 1s infinite ease-in-out;
        }

        .loading-bars-inline .bar:nth-child(2) { animation-delay: 0.1s; opacity: 0.8; }
        .loading-bars-inline .bar:nth-child(3) { animation-delay: 0.2s; opacity: 0.6; }

        @keyframes waveInline {
          0%, 40%, 100% { transform: scaleY(0.5); }
          20% { transform: scaleY(1.2); }
        }

        .spinner { display: none; }

        .hidden { display: none; }
        
        .upload-container {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .upload-box {
          flex: 1;
          height: 60px;
          border: 2px dashed #cbd5e1;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s;
          background: #f8fafc;
        }

        .upload-box:hover {
          border-color: #3aa6ff;
          background: #f0f9ff;
        }

        .upload-box.uploading {
          cursor: wait;
          opacity: 0.7;
        }

        .upload-placeholder {
          display: flex;
          items-center: center;
          gap: 10px;
          color: #64748b;
          font-size: 0.875rem;
        }

        .upload-placeholder i {
          font-size: 1.25rem;
        }

        .uploaded-info {
          display: flex;
          items-center: center;
          gap: 10px;
          color: #10b981;
          font-weight: 600;
          font-size: 0.875rem;
        }

        .remove-file {
          padding: 8px 12px;
          background: #fee2e2;
          color: #ef4444;
          border: none;
          border-radius: 8px;
          font-size: 0.75rem;
          font-weight: 600;
          cursor: pointer;
        }

        .spinner-sm {
          width: 20px;
          height: 20px;
          border: 2px solid #e2e8f0;
          border-top-color: #3aa6ff;
          border-radius: 50%;
          animation: spin 0.6s linear infinite;
        }
      `}</style>
        </div>
    );
}
